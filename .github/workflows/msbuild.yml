name: Build JiTou Unlock

on:
  push:
    branches: [ main, master ]

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Qt
      uses: actions/setup-qt@v3
      with:
        qt-version: '6.5.0'
        
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1
      with:
        cmake-version: '3.26.x'
        
    - name: Build Project
      run: |
        echo "当前目录结构:"
        dir
        
        echo "尝试构建..."
        # 先尝试项目自带的构建脚本
        if (Test-Path "build_windows.bat") {
          echo "使用 build_windows.bat"
          cmd /c "build_windows.bat"
        } elseif (Test-Path "quick_build.bat") {
          echo "使用 quick_build.bat" 
          cmd /c "quick_build.bat"
        } else {
          echo "使用手动CMake构建"
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          cmake --build . --config Release --parallel 4
        }
        
    - name: Check Build Results
      run: |
        echo "检查构建输出..."
        if (Test-Path "dist") {
          echo "dist目录内容:"
          Get-ChildItem -Path "dist" -Recurse
        }
        if (Test-Path "build") {
          echo "build目录内容:"
          Get-ChildItem -Path "build" -Recurse -Include *.exe
        }
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: JiTou-Unlock-Windows
        path: |
          dist/
          build/
        if-no-files-found: warn
