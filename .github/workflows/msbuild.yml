name: Build Qt Project

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt and Build Tools
      uses: jurplel/setup-qt-action@v3
      with:
        version: '6.5.0'
        arch: 'x64'
      
    - name: Build with CMake
      run: |
        # 创建构建目录
        mkdir build
        cd build
        
        # 配置项目
        cmake -DCMAKE_BUILD_TYPE=Release ..
        
        # 编译
        cmake --build . --config Release --parallel 4
        
        # 如果项目有部署目标，尝试运行
        cmake --build . --config Release --target Script-DeployRelease 2>nul || echo "部署目标不存在，跳过"
      
    - name: List build results
      run: |
        echo "=== 构建结果 ==="
        dir *.exe /s 2>nul || echo "未找到exe文件"
        if (Test-Path "dist") {
          echo "=== dist目录 ==="
          Get-ChildItem -Path "dist" -Recurse
        }
        if (Test-Path "build") {
          echo "=== build目录 ==="
          Get-ChildItem -Path "build" -Recurse -Include *.exe
        }
        
    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: JiTou-Unlock
        path: |
          *.exe
          dist/
          build/*.exe
          build/Release/*.exe
        if-no-files-found: warn
